server {
    listen 443 ssl http2;
    server_name djapi.eruditesuganda.com;

    # --- SSL Configuration ---
    ssl_certificate     /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/private_key.key;

    # Nginx Root: Where Nginx looks for static files (e.g., media/static volumes)
    root /var/www/api2/public;
    index index.php index.html;

    # --- 1. Main Request Handling (The Laravel Fallback) ---
    location / {
        # 1. Try to find the requested file ($uri) or directory ($uri/).
        # 2. If neither is found, pass the request to the named location @php.
        try_files $uri $uri/ @php;
    }

    # --- 2. PHP-FPM Handler (The @php named location) ---
    location @php {
        # This tells PHP-FPM exactly which file to execute: the absolute path
        # to the Laravel entry point INSIDE the 'api2' container.
        fastcgi_param SCRIPT_FILENAME /app/public/index.php;

        include fastcgi_params;
        fastcgi_pass api2:9000;
    }

    # --- 3. Prevent Direct Access to PHP Files ---
    # This location handles requests for any file ending in .php that wasn't
    # already routed through the @php handler (which only uses index.php).
    location ~ \.php$ {
        # Block direct access to files like 'malicious.php' in the public folder.
        return 404;
    }

    # Optional: Deny access to hidden files
    location ~ /\. {
        deny all;
    }
}