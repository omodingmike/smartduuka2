limit_req_zone $binary_remote_addr zone=mylimit:10m rate=10r/s;

# ----------------------
# HTTP -> HTTPS redirect
# ----------------------
server {
    listen      80;
    listen      [::]:80;
    server_name piwie.eruditesuganda.com piwieapi.eruditesuganda.com dj.eruditesuganda.com;
    return      301                      https://$host$request_uri;
}

# ----------------------
# Frontend (Next.js) - piwie.eruditesuganda.com
# ----------------------
server {
    listen      443                      ssl http2;
    server_name piwie.eruditesuganda.com;
    ssl_certificate     /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/private_key.key;
    ssl_protocols       TLSv1.2                        TLSv1.3;
    location / {
        proxy_pass         http://frontend:3000;
        proxy_http_version 1.1;
        proxy_set_header   Host                 $host;
        proxy_set_header   X-Real-IP            $remote_addr;
        proxy_set_header   X-Forwarded-For      $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto    $scheme;
        proxy_set_header   Upgrade              $http_upgrade;
        proxy_set_header   Connection           "upgrade";
        proxy_buffering    off;
    }
}

# ----------------------
# Frontend (Next.js) - dj.eruditesuganda.com
# ----------------------
server {
    listen      443                      ssl http2;
    server_name dj.eruditesuganda.com;
    ssl_certificate     /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/private_key.key;
    ssl_protocols       TLSv1.2                        TLSv1.3;
    location / {
        proxy_pass         http://dj:3000;
        proxy_http_version 1.1;
        proxy_set_header   Host                 $host;
        proxy_set_header   X-Real-IP            $remote_addr;
        proxy_set_header   X-Forwarded-For      $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto    $scheme;
        proxy_set_header   Upgrade              $http_upgrade;
        proxy_set_header   Connection           "upgrade";
        proxy_buffering    off;
    }
}
# ----------------------
# Backend (Laravel API) - piwieapi.eruditesuganda.com
# ----------------------
server {
    listen      443                         ssl http2;
    listen      [::]:443                    ssl http2;
    server_name piwieapi.eruditesuganda.com;

    # SSL certificates are mounted from the VPS host's /etc/nginx/ssl
    ssl_certificate           /etc/nginx/ssl/cert.pem;
    ssl_certificate_key       /etc/nginx/ssl/private_key.key;
    ssl_protocols             TLSv1.2                        TLSv1.3;
    ssl_ciphers               HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # Nginx uses a dummy root, as it is mainly a proxy.
    # root        /var/www/html; # A directory that exists inside the Nginx container
    root        /var/www/api/public;
    index index.php   index.html;

    add_header X-Frame-Options        "SAMEORIGIN";
    add_header X-Content-Type-Options "nosniff";
    charset    utf-8;

    # ... (other header settings) ...

    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    location = /favicon.ico { access_log off; log_not_found off; }
    location = /robots.txt { access_log off; log_not_found off; }

    error_page 404 /index.php;

    # Pass PHP requests to the 'api' PHP-FPM service
    location ~ ^/index\.php(/|$) {
        set $real_root /app/public; # Application root path inside the 'api' container

        include              fastcgi_params;
        fastcgi_param        SCRIPT_FILENAME $real_root$fastcgi_script_name;

        # Talk to php-fpm by service name (api) on Docker network
        fastcgi_pass         api:9000;

        fastcgi_index        index.php;
        fastcgi_buffers      16              16k;
        fastcgi_buffer_size  32k;
        fastcgi_read_timeout 300;
        fastcgi_hide_header  X-Powered-By;
    }

    # Deny direct access to other PHP files
    location ~ \.php$ {
        return 404;
    }

    # Deny access to hidden files (except .well-known)
    location ~ /\.(?!well-known).* {
        deny all;
    }
}